<div class="app-container">
  <header class="navigation-bar">
    <nav class="tab-navigation" role="tablist" [attr.data-active-tab]="activeTab === 'tram' ? '1' : activeTab === 'bus' ? '2' : '3'">
      <button
        class="nav-tab"
        [class.active]="activeTab === 'tram'"
        (click)="setActiveTab('tram')"
        role="tab"
        [attr.aria-selected]="activeTab === 'tram'"
        aria-label="Tram stops">
        <div class="tab-content">
          <img class="tab-icon" src="assets/icons/tram.svg" alt="">
          <span class="tab-label">Tram</span>
        </div>
      </button>
      <button
        class="nav-tab"
        [class.active]="activeTab === 'bus'"
        (click)="setActiveTab('bus')"
        role="tab"
        [attr.aria-selected]="activeTab === 'bus'"
        aria-label="Bus stops">
        <div class="tab-content">
          <img class="tab-icon" src="assets/icons/bus.svg" alt="">
          <span class="tab-label">Bus</span>
        </div>
      </button>
      <button
        class="nav-tab"
        [class.active]="activeTab === 'map'"
        (click)="setActiveTab('map')"
        role="tab"
        [attr.aria-selected]="activeTab === 'map'"
        aria-label="Map view">
        <div class="tab-content">
          <img class="tab-icon" src="assets/icons/map.svg" alt="">
          <span class="tab-label">Map</span>
        </div>
      </button>
    </nav>
  </header>

  <main class="main-content" role="main">
    <section class="content-panel" [class.active]="activeTab === 'tram' || activeTab === 'bus'" role="tabpanel">
      <div class="content-wrapper">
        <div class="loading-state" *ngIf="isLoading">
          <div class="loading-indicator">
            <div class="spinner-ring"></div>
            <p class="loading-text">{{ loadingMessage }}</p>
          </div>
        </div>

        <div class="error-state" *ngIf="error && !isLoading">
          <div class="error-card">
            <div class="error-icon" aria-hidden="true">ğŸš</div>
            <p class="error-message">{{ error }}</p>
            <button class="action-button retry-button" (click)="retryLoadStops()">
              Erneut versuchen
            </button>
          </div>
        </div>

        <div class="stops-grid" *ngIf="!isLoading && !error && nearestStops.length > 0">
          <article class="stop-card" *ngFor="let stop of nearestStops; let i = index"
                   [class.expanded]="stop.expanded"
                   (click)="toggleStopExpansion(i)"
                   role="button"
                   tabindex="0"
                   [attr.aria-expanded]="stop.expanded">
            <div class="card-content">
              <header class="stop-header">
                <div class="stop-info">
                  <h3 class="stop-name">
                    {{ stop.stop_name }} {{ stop.stop_num }}
                  </h3>
                  <span class="distance-badge">{{ (stop.distance! * 1000) | number:'1.0-0' }}m</span>
                </div>
                <button class="expand-button" [class.rotated]="stop.expanded" aria-hidden="true">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </header>

              <div class="directions-section" *ngIf="!stop.loadingDirections && stop.directions && stop.directions.length > 0">
                <div class="directions-grid">
                  <span class="direction-tag" *ngFor="let direction of stop.directions">{{ direction }}</span>
                </div>
              </div>

              <div class="loading-inline" *ngIf="stop.loadingDirections">
                <div class="mini-spinner"></div>
                <span class="loading-text-small">Lade Richtungen...</span>
              </div>

              <div class="departures-container"
                   [class.collapsing]="stop.collapsing"
                   *ngIf="stop.expanded || stop.collapsing">
                <div class="departures-loading" *ngIf="stop.loadingDepartures">
                  <div class="mini-spinner"></div>
                  <span class="loading-text-small">Lade Abfahrten...</span>
                </div>

                <div class="departures-section" *ngIf="!stop.loadingDepartures && stop.departures && stop.departures.length > 0">
                  <h4 class="section-title">Abfahrten</h4>
                  <div class="departures-grid">
                    <div class="departure-card" *ngFor="let departure of stop.departures">
                      <div class="line-badge">{{ departure.line }}</div>
                      <div class="departure-info">
                        <div class="direction-text">{{ departure.direction }}</div>
                        <div class="vehicle-info"
                             *ngIf="departure.vehicleNumber && departure.vehicleNumber.trim() !== ''"
                             (click)="copyToClipboard(departure.vehicleNumber, $event)"
                             title="Klicken zum Kopieren">
                          {{ departure.vehicleNumber }}
                        </div>
                      </div>
                      <div class="time-badge">{{ departure.minutesUntilDeparture }} min</div>
                    </div>
                  </div>
                </div>

                <div class="empty-state" *ngIf="!stop.loadingDepartures && (!stop.departures || stop.departures.length === 0)">
                  <p>Keine Abfahrten verfÃ¼gbar</p>
                </div>
              </div>
            </div>
          </article>
        </div>
      </div>
    </section>

    <section class="content-panel" [class.active]="activeTab === 'map'" role="tabpanel">
      <app-map></app-map>
    </section>
  </main>
</div>

<router-outlet/>
